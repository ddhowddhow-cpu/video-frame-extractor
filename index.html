  <!-- ffmpeg UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
  <!-- JSZip CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const videoInput = document.getElementById("video");
    const goBtn = document.getElementById("go");
    const zipBtn = document.getElementById("zip");
    const status = document.getElementById("status");
    const result = document.getElementById("result");
    let frames = [];

    // ffmpeg ì¸ìŠ¤í„´ìŠ¤ëŠ” ë‚˜ì¤‘ì— í•„ìš”í•  ë•Œ ìƒì„±
    let ffmpeg = null;
    let fetchFileFn = null;

    async function ensureFFmpeg() {
      // ì´ë¯¸ ì¤€ë¹„ëìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      if (ffmpeg) return;

      if (!window.FFmpeg) {
        throw new Error("FFmpeg ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
      const { createFFmpeg, fetchFile } = window.FFmpeg;
      fetchFileFn = fetchFile;
      ffmpeg = createFFmpeg({
        log: false,
        corePath: "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/umd/ffmpeg-core.js"
      });

      await ffmpeg.load();
    }

    // 1) íŒŒì¼ ì„ íƒ ì‹œ íŒŒëž€ ë²„íŠ¼ í™œì„±í™” (ì´ê±´ FFmpegì™€ ìƒê´€ì—†ì´ í•­ìƒ ì‚´ì•„ìžˆì–´ì•¼ í•¨)
    videoInput.addEventListener("change", () => {
      if (videoInput.files[0]) {
        goBtn.disabled = false;
        status.innerHTML =
          `<strong>${videoInput.files[0].name}</strong>\níŒŒëž€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í”„ë ˆìž„ì„ ì¶”ì¶œí•©ë‹ˆë‹¤!`;
      }
    });

    // 2) í”„ë ˆìž„ ì¶”ì¶œ
    goBtn.addEventListener("click", async () => {
      const file = videoInput.files[0];
      if (!file) return;

      goBtn.disabled = true;
      zipBtn.disabled = true;
      result.innerHTML = "";
      frames = [];
      status.textContent = "ffmpeg ë¡œë”© ì¤‘... (ì²˜ìŒì€ 10~40ì´ˆ ê±¸ë¦´ ìˆ˜ ìžˆìŒ)";

      try {
        await ensureFFmpeg(); // ì—¬ê¸°ì„œë§Œ FFmpeg ì¤€ë¹„

        status.textContent = "í”„ë ˆìž„ ì¶”ì¶œ ì¤‘...";

        ffmpeg.FS("writeFile", "input.mp4", await fetchFileFn(file));

        const sec = document.getElementById("interval").value;

        await ffmpeg.run(
          "-i", "input.mp4",
          "-vf", `fps=1/${sec}`,
          "-q:v", "2",
          "frame_%05d.jpg"
        );

        const files = ffmpeg.FS("readdir", ".").filter(f => f.startsWith("frame_"));

        files.forEach(f => {
          const data = ffmpeg.FS("readFile", f);
          const blob = new Blob([data.buffer], { type: "image/jpeg" });
          frames.push(blob);

          const img = new Image();
          img.src = URL.createObjectURL(blob);
          img.loading = "lazy";
          result.appendChild(img);
        });

        status.textContent = `ì™„ë£Œ! ì´ ${files.length}ìž¥ì˜ í”„ë ˆìž„ì´ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤ ðŸŽ‰`;
        zipBtn.disabled = frames.length === 0;
      } catch (e) {
        console.error(e);
        status.textContent = `ì—ëŸ¬ ë°œìƒ: ${e.message || e}`;
      }

      goBtn.disabled = false;
    });

    // 3) ZIP ë‹¤ìš´ë¡œë“œ
    zipBtn.addEventListener("click", async () => {
      if (!frames.length) return;

      zipBtn.disabled = true;
      status.textContent = "ZIP íŒŒì¼ ìƒì„± ì¤‘...";

      const zip = new JSZip();
      frames.forEach((blob, i) => {
        zip.file(`frame_${String(i + 1).padStart(4, "0")}.jpg`, blob);
      });

      const content = await zip.generateAsync({ type: "blob" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(content);
      a.download = "frames.zip";
      a.click();

      status.textContent = "ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!";
      zipBtn.disabled = false;
    });
  </script>
