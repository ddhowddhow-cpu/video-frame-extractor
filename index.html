<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ìƒ â†’ ì´ë¯¸ì§€ í”„ë ˆì„ ì¶”ì¶œê¸° (ë¸Œë¼ìš°ì € ë²„ì „)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 960px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .desc {
      text-align: center;
      color: #666;
      margin-bottom: 24px;
      font-size: 14px;
      line-height: 1.4;
    }
    .upload-box {
      border: 2px dashed #ccc;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }
    .upload-box input[type="file"] {
      margin-top: 8px;
    }
    button {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #status {
      margin-top: 12px;
      text-align: center;
      font-size: 14px;
      color: #444;
      white-space: pre-line;
    }
    .frames {
      margin-top: 32px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .frames img {
      width: 220px;
      border-radius: 8px;
      border: 1px solid #ddd;
      object-fit: cover;
    }
    .download-box {
      margin-top: 16px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>ğŸ¬ ì˜ìƒ â†’ ğŸ–¼ ì´ë¯¸ì§€ í”„ë ˆì„ ì¶”ì¶œ (ffmpeg.wasm)</h1>
  <div class="desc">
    ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´, ë¸Œë¼ìš°ì € ì•ˆì—ì„œ ffmpegë¡œ í”„ë ˆì„ì„ ì¶”ì¶œí•´ ë°”ë¡œ ì•„ë˜ì— ë³´ì—¬ì¤ë‹ˆë‹¤.<br>
    (íŒŒì¼ì€ ì„œë²„ë¡œ ì—…ë¡œë“œë˜ì§€ ì•Šê³ , ê°ì PC ë¸Œë¼ìš°ì € ì•ˆì—ì„œë§Œ ì²˜ë¦¬ë¼ìš”.)
  </div>

  <div class="upload-box">
    <div>1. ì˜ìƒ íŒŒì¼ ì„ íƒ (mp4, mov ë“±)</div>
    <input id="videoInput" type="file" accept="video/*" />

    <!-- í”„ë ˆì„ ê°„ê²© ì„ íƒ (0.5ì´ˆ ~ 10ì´ˆ, 0.5ì´ˆ ë‹¨ìœ„) -->
    <div style="margin-top:10px;">
      í”„ë ˆì„ ê°„ê²© ì„ íƒ :
      <select id="intervalSelect">
        <option value="0.5">0.5ì´ˆ</option>
        <option value="1" selected>1ì´ˆ</option>
        <option value="1.5">1.5ì´ˆ</option>
        <option value="2">2ì´ˆ</option>
        <option value="2.5">2.5ì´ˆ</option>
        <option value="3">3ì´ˆ</option>
        <option value="3.5">3.5ì´ˆ</option>
        <option value="4">4ì´ˆ</option>
        <option value="4.5">4.5ì´ˆ</option>
        <option value="5">5ì´ˆ</option>
        <option value="5.5">5.5ì´ˆ</option>
        <option value="6">6ì´ˆ</option>
        <option value="6.5">6.5ì´ˆ</option>
        <option value="7">7ì´ˆ</option>
        <option value="7.5">7.5ì´ˆ</option>
        <option value="8">8ì´ˆ</option>
        <option value="8.5">8.5ì´ˆ</option>
        <option value="9">9ì´ˆ</option>
        <option value="9.5">9.5ì´ˆ</option>
        <option value="10">10ì´ˆ</option>
      </select>
    </div>

    <div>2. ì•„ë˜ ë²„íŠ¼ í´ë¦­í•´ì„œ í”„ë ˆì„ ì¶”ì¶œ</div>
    <button id="extractBtn">í”„ë ˆì„ ì¶”ì¶œí•˜ê¸°</button>
    <div id="status"></div>
  </div>

  <div class="download-box">
    <button id="downloadZipBtn" disabled>ëª¨ë“  í”„ë ˆì„ ZIPìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <div id="frames" class="frames"></div>

  <!-- JSZip (ZIP íŒŒì¼ ìƒì„±ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // ffmpeg ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—¬ëŸ¬ CDNì—ì„œ ë¡œë“œí•˜ëŠ” í—¬í¼
    function loadFFmpegScript() {
      return new Promise((resolve, reject) => {
        if (window.FFmpeg) {
          resolve();
          return;
        }

        const cdnList = [
          'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js',
          'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js'
        ];

        let index = 0;

        function tryNext() {
          if (index >= cdnList.length) {
            reject(new Error('All FFmpeg CDNs failed to load'));
            return;
          }

          const src = cdnList[index++];
          const script = document.createElement('script');
          script.src = src;
          script.onload = () => {
            if (window.FFmpeg) {
              resolve();
            } else {
              tryNext();
            }
          };
          script.onerror = () => {
            console.warn('FFmpeg CDN load failed:', src);
            tryNext();
          };
          document.head.appendChild(script);
        }

        tryNext();
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const videoInput = document.getElementById('videoInput');
      const intervalSelect = document.getElementById('intervalSelect');
      const extractBtn = document.getElementById('extractBtn');
      const downloadZipBtn = document.getElementById('downloadZipBtn');
      const statusEl = document.getElementById('status');
      const framesEl = document.getElementById('frames');

      let ffmpeg = null;
      let selectedFile = null;
      let createFFmpegFn = null;
      let fetchFileFn = null;

      let framesData = []; // { name, data( Uint8Array ) }

      extractBtn.disabled = true;
      downloadZipBtn.disabled = true;

      videoInput.addEventListener('change', (e) => {
        selectedFile = e.target.files[0];
        framesData = [];
        framesEl.innerHTML = '';
        downloadZipBtn.disabled = true;

        if (selectedFile) {
          extractBtn.disabled = false;
          statusEl.textContent = `ì„ íƒëœ íŒŒì¼: ${selectedFile.name}`;
        } else {
          extractBtn.disabled = true;
          statusEl.textContent = '';
        }
      });

      async function initFFmpeg() {
        if (!window.FFmpeg) {
          statusEl.textContent = 'ffmpeg ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
          await loadFFmpegScript();
        }

        if (!window.FFmpeg) {
          statusEl.textContent = 'âš  ffmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\në„¤íŠ¸ì›Œí¬ ë˜ëŠ” ê´‘ê³  ì°¨ë‹¨ê¸°ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.';
          throw new Error('FFmpeg not loaded');
        }

        if (!createFFmpegFn || !fetchFileFn) {
          const { createFFmpeg, fetchFile } = window.FFmpeg;
          createFFmpegFn = createFFmpeg;
          fetchFileFn = fetchFile;
        }

        if (!ffmpeg) {
          ffmpeg = createFFmpegFn({
            // coreë„ ë©€í‹° CDNì´ í•„ìš”í•˜ë©´ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•˜ì§€ë§Œ,
            // ì—¬ê¸°ì„  jsDelivr í•˜ë‚˜ë§Œ ì‚¬ìš©
            corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/ffmpeg-core.js',
            log: true,
          });
        }

        if (!ffmpeg.isLoaded()) {
          statusEl.textContent = 'ffmpeg ë¡œë”© ì¤‘ì…ë‹ˆë‹¤... (ì²˜ìŒ í•œ ë²ˆë§Œ ì¡°ê¸ˆ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤)';
          await ffmpeg.load();
        }
      }

      extractBtn.addEventListener('click', async () => {
        if (!selectedFile) {
          alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
          return;
        }

        extractBtn.disabled = true;
        downloadZipBtn.disabled = true;
        framesEl.innerHTML = '';
        framesData = [];
        statusEl.textContent = 'ì¤€ë¹„ ì¤‘...';

        try {
          await initFFmpeg();

          const ext = selectedFile.name.includes('.') ? '.' + selectedFile.name.split('.').pop() : '.mp4';
          const inputName = 'input_video' + ext;

          await ffmpeg.FS('writeFile', inputName, await fetchFileFn(selectedFile));

          const interval = parseFloat(intervalSelect.value) || 1;
          const fpsValue = 1 / interval;

          statusEl.textContent =
            `í”„ë ˆì„ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...\n(ì„¤ì •ëœ ê°„ê²©: ${interval}ì´ˆ, fps â‰ˆ ${fpsValue.toFixed(3)})\nì˜ìƒ ê¸¸ì´ì— ë”°ë¼ ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”.`;

          await ffmpeg.run(
            '-i', inputName,
            '-vf', `fps=${fpsValue}`,
            'frame_%03d.jpg'
          );

          statusEl.textContent = 'ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

          let index = 1;
          let found = 0;

          while (true) {
            const filename = `frame_${String(index).padStart(3, '0')}.jpg`;
            try {
              const data = ffmpeg.FS('readFile', filename);
              framesData.push({ name: filename, data });

              const blob = new Blob([data.buffer], { type: 'image/jpeg' });
              const url = URL.createObjectURL(blob);

              const img = document.createElement('img');
              img.src = url;
              framesEl.appendChild(img);

              found++;
              index++;
            } catch (err) {
              break;
            }
          }

          if (found === 0) {
            statusEl.textContent = 'ì¶”ì¶œëœ í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤. (ì˜ìƒ í¬ë§· ë¬¸ì œì¼ ìˆ˜ ìˆì–´ìš”)';
            downloadZipBtn.disabled = true;
          } else {
            statusEl.textContent = `âœ… í”„ë ˆì„ ${found}ì¥ì´ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.\n(ê°„ê²©: ${interval}ì´ˆ)\nì•„ë˜ ì´ë¯¸ì§€ì™€ ZIP ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ í™•ì¸í•˜ì„¸ìš”.`;
            downloadZipBtn.disabled = false;
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err;
          downloadZipBtn.disabled = true;
        } finally {
          extractBtn.disabled = false;
        }
      });

      downloadZipBtn.addEventListener('click', async () => {
        if (!framesData.length) {
          alert('ë¨¼ì € í”„ë ˆì„ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.');
          return;
        }
        if (!window.JSZip) {
          alert('ZIP ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          downloadZipBtn.disabled = true;
          statusEl.textContent = 'ZIP íŒŒì¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...';

          const zip = new JSZip();
          framesData.forEach(frame => {
            zip.file(frame.name, frame.data);
          });

          const content = await zip.generateAsync({ type: 'blob' });
          const url = URL.createObjectURL(content);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'frames.zip';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          statusEl.textContent = 'âœ… ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'ZIP ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err;
        } finally {
          downloadZipBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
