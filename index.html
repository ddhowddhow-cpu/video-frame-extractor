<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ìƒ â†’ ì´ë¯¸ì§€ í”„ë ˆì„ ì¶”ì¶œê¸° (ë¸Œë¼ìš°ì € ë²„ì „)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 960px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 { text-align: center; margin-bottom: 10px; }
    .desc { text-align: center; color: #666; margin-bottom: 24px; font-size: 14px; line-height: 1.4; }
    .upload-box { border: 2px dashed #ccc; border-radius: 12px; padding: 24px; text-align: center; }
    .upload-box input[type="file"] { margin-top: 8px; }
    button { margin-top: 16px; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; background:#007bff; color:white; }
    button:disabled { opacity: 0.5; cursor: default; background:#999; }
    #status { margin-top: 12px; text-align: center; font-size: 14px; color: #444; white-space: pre-line; }
    .frames { margin-top: 32px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .frames img { width: 220px; height: 124px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
    .download-box { margin-top: 16px; text-align: center; }
  </style>
</head>
<body>
  <h1>ğŸ¬ ì˜ìƒ â†’ ğŸ–¼ ì´ë¯¸ì§€ í”„ë ˆì„ ì¶”ì¶œ (ffmpeg.wasm)</h1>
  <div class="desc">
    ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë¸Œë¼ìš°ì € ì•ˆì—ì„œë§Œ í”„ë ˆì„ì´ ì¶”ì¶œë©ë‹ˆë‹¤.<br>
    (ì„œë²„ë¡œ ì—…ë¡œë“œë˜ì§€ ì•Šì•„ìš”!)
  </div>

  <div class="upload-box">
    <div>1. ì˜ìƒ íŒŒì¼ ì„ íƒ (mp4, mov, webm ë“±)</div>
    <input id="videoInput" type="file" accept="video/*" />

    <div style="margin-top:10px;">
      í”„ë ˆì„ ê°„ê²© :
      <select id="intervalSelect">
        <option value="0.5">0.5ì´ˆ</option>
        <option value="1" selected>1ì´ˆ</option>
        <option value="2">2ì´ˆ</option>
        <option value="3">3ì´ˆ</option>
        <option value="5">5ì´ˆ</option>
        <option value="10">10ì´ˆ</option>
      </select>
    </div>

    <div style="margin-top:10px;">2. ì¶”ì¶œ ì‹œì‘</div>
    <button id="extractBtn">í”„ë ˆì„ ì¶”ì¶œí•˜ê¸°</button>
    <div id="status"></div>
  </div>

  <div class="download-box">
    <button id="downloadZipBtn" disabled>ëª¨ë“  í”„ë ˆì„ ZIPìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <div id="frames" class="frames"></div>

  <!-- ffmpeg.wasm (í•œêµ­ì—ì„œ ê°€ì¥ ì˜ ë˜ëŠ” ì¡°í•©) -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({
      // í•œêµ­ì—ì„œ ì œì¼ ì•ˆì •ì ì¸ ê²½ë¡œ (unpkgê°€ jsDelivrë³´ë‹¤ í›¨ì”¬ ì˜ ëš«ë¦¼)
      corePath: 'https://unpkg.com/@ffmpeg/core@0.12.6/ffmpeg-core.js',
      wasmPath: 'https://unpkg.com/@ffmpeg/core@0.12.6/ffmpeg-core.wasm',
      workerPath: 'https://unpkg.com/@ffmpeg/core@0.12.6/ffmpeg-core.worker.js',
      log: true,
    });

    let loaded = false;

    const videoInput = document.getElementById('videoInput');
    const intervalSelect = document.getElementById('intervalSelect');
    const extractBtn = document.getElementById('extractBtn');
    const downloadZipBtn = document.getElementById('downloadZipBtn');
    const statusEl = document.getElementById('status');
    const framesEl = document.getElementById('frames');

    let selectedFile = null;
    let framesData = [];

    extractBtn.disabled = true;
    downloadZipBtn.disabled = true;

    videoInput.addEventListener('change', e => {
      selectedFile = e.target.files[0];
      framesData = [];
      framesEl.innerHTML = '';
      downloadZipBtn.disabled = true;
      if (selectedFile) {
        extractBtn.disabled = false;
        statusEl.textContent = `ì„ íƒëœ íŒŒì¼: ${selectedFile.name} (${(selectedFile.size/1024/1024).toFixed(1)} MB)`;
      }
    });

    async function loadFFmpeg() {
      if (loaded) return;
      statusEl.textContent = 'ffmpeg.wasm ë¡œë”© ì¤‘...\n(ìµœì´ˆ 1íšŒ 30~60ì´ˆ ì •ë„ ê±¸ë ¤ìš”. ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!)';
      await ffmpeg.load();
      loaded = true;
      statusEl.textContent += '\nâœ… ffmpeg ë¡œë“œ ì™„ë£Œ!';
    }

    extractBtn.addEventListener('click', async () => {
      if (!selectedFile) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');

      extractBtn.disabled = true;
      downloadZipBtn.disabled = true;
      framesEl.innerHTML = '';
      framesData = [];
      statusEl.textContent = 'ffmpeg ì¤€ë¹„ ì¤‘...';

      try {
        await loadFFmpeg();

        const ext = selectedFile.name.split('.').pop();
        const inputName = `input.${ext}`;
        ffmpeg.FS('writeFile', inputName, await fetchFile(selectedFile));

        const interval = parseFloat(intervalSelect.value);
        const fps = (1 / interval).toFixed(3);

        statusEl.textContent = `í”„ë ˆì„ ì¶”ì¶œ ì¤‘... (ê°„ê²© ${interval}ì´ˆ, fps=${fps})\nì˜ìƒ ê¸¸ì´ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë ¤ìš”`;

        await ffmpeg.run('-i', inputName, '-vf', `fps=${fps}`, '-q:v', '2', 'frame_%04d.jpg');

        const files = ffmpeg.FS('readdir', '/');
        const frameFiles = files.filter(f => f.startsWith('frame_'));

        for (const file of frameFiles) {
          const data = ffmpeg.FS('readFile', file);
          framesData.push({ name: file, data });

          const blob = new Blob([data], { type: 'image/jpeg' });
          const url = URL.createObjectURL(blob);
          const img = document.createElement('img');
          img.src = url;
          framesEl.appendChild(img);
        }

        statusEl.textContent = `âœ… ì™„ë£Œ! ${frameFiles.length}ì¥ ì¶”ì¶œë¨\nZIP ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥`;
        downloadZipBtn.disabled = false;

      } catch (err) {
        console.error(err);
        statusEl.textContent = `ì˜¤ë¥˜ ë°œìƒ:\n${err.message}\n\ní•´ê²°ë²•:\n1. ê´‘ê³ ì°¨ë‹¨ê¸° ë„ê¸°\n2. Ctrl+F5 ê°•ì œ ìƒˆë¡œê³ ì¹¨\n3. ëª¨ë°”ì¼ ë°ì´í„°ë¡œ ì‹œë„`;
      } finally {
        extractBtn.disabled = false;
      }
    });

    downloadZipBtn.addEventListener('click', async () => {
      downloadZipBtn.disabled = true;
      statusEl.textContent = 'ZIP ì••ì¶• ì¤‘...';

      const zip = new JSZip();
      framesData.forEach(f => zip.file(f.name, f.data));
      const blob = await zip.generateAsync({ type: 'blob' });

      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'frames.zip';
      a.click();

      statusEl.textContent = 'âœ… ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!';
      downloadZipBtn.disabled = false;
    });
  </script>
</body>
</html>
